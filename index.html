<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דשבורד ניתוח חלופות - העתקת מטה החברה</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js DataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Heebo', sans-serif;
            background-color: #f8fafc; /* Slate 50 */
            color: #1e293b; /* Slate 800 */
        }

        /* Color Palette */
        .text-primary { color: #004aad; }
        .bg-primary { background-color: #004aad; }
        .border-primary { border-color: #004aad; }
        
        .text-secondary { color: #38b6ff; }
        .bg-secondary { background-color: #38b6ff; }

        /* Navigation Active State */
        .nav-item.active {
            border-bottom: 3px solid #004aad;
            color: #004aad;
            font-weight: 700;
        }

        /* Scenario Button Active State */
        .scenario-btn {
            transition: all 0.2s ease-in-out;
        }
        .scenario-btn:active {
            transform: scale(0.98);
        }
        .scenario-btn.active {
            background-color: #e0f2fe; /* blue-100 */
            border-color: #38b6ff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Compact Range Slider */
        input[type=range] {
            height: 20px;
            -webkit-appearance: none;
            margin: 5px 0;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus {
            outline: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #004aad;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        /* Edit Inputs */
        .score-input {
            width: 40px;
            text-align: center;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            padding: 2px;
            font-size: 0.75rem;
        }
        .score-input:focus {
            outline: none;
            border-color: #004aad;
            background-color: #f0f9ff;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            width: 100%;
            height: 250px; /* More compact for mobile */
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 320px;
            }
        }

        /* Map Container */
        #map {
            height: 600px;
            width: 100%;
            border-radius: 0.75rem;
            z-index: 1; /* Ensure map is below nav but above background */
        }
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
            font-family: 'Heebo', sans-serif;
            text-align: right;
        }
        .leaflet-popup-tip {
            background: white;
        }

        /* Table Transitions */
        .drilldown-row {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .drilldown-row.open {
            max-height: 500px;
            opacity: 1;
        }

        /* Report Typography */
        .report-content h2 { font-size: 1.25rem; font-weight: 700; color: #004aad; margin-top: 2rem; margin-bottom: 0.75rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }
        .report-content h3 { font-size: 1.1rem; font-weight: 700; color: #334155; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .report-content h4 { font-size: 1rem; font-weight: 700; color: #475569; margin-top: 1rem; margin-bottom: 0.25rem; }
        .report-content p { margin-bottom: 0.75rem; line-height: 1.6; color: #475569; font-size: 0.95rem; text-align: justify; }
        .report-content ul, .report-content ol { padding-right: 1.5rem; margin-bottom: 1rem; color: #475569; font-size: 0.95rem; }
        .report-content ul { list-style-type: disc; }
        .report-content ol { list-style-type: decimal; }
        .report-content li { margin-bottom: 0.5rem; }
        .report-content strong { color: #1e293b; font-weight: 700; }
        
        /* Report Tables */
        .report-table-wrapper { overflow-x: auto; margin-bottom: 1.5rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; }
        .report-table { width: 100%; font-size: 0.85rem; text-align: right; border-collapse: collapse; min-width: 600px; }
        .report-table th { background-color: #f1f5f9; color: #334155; font-weight: 700; padding: 0.75rem; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
        .report-table td { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; color: #475569; vertical-align: top; }
        .report-table tr:last-child td { border-bottom: none; }
        .report-table tr:nth-child(even) { background-color: #f8fafc; }

        /* Mobile Adjustments */
        @media (max-width: 640px) {
            .mobile-stack { flex-direction: column; }
            .mobile-full { width: 100%; }
            .hide-mobile { display: none; }
            #map { height: 400px; }
            h1 { font-size: 1.25rem; }
            h2 { font-size: 1.1rem; }
        }
    </style>
</head>
<body>

    <!-- Top Navigation Bar -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-building-columns text-primary text-xl ml-2"></i>
                    <div>
                        <h1 class="text-lg font-bold text-slate-800 leading-none">העתקת מטה החברה - ניתוח חלופות</h1>
                        <span class="text-[10px] text-slate-500">גרסה V2</span>
                    </div>
                </div>
                <div class="flex space-x-2 md:space-x-4 space-x-reverse h-full items-end pb-1 overflow-x-auto no-scrollbar">
                    <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item active px-2 py-2 text-xs md:text-sm font-medium text-slate-600 whitespace-nowrap">
                        <i class="fa-solid fa-chart-pie ml-1"></i> דשבורד
                    </button>
                    <button onclick="switchView('custom')" id="nav-custom" class="nav-item px-2 py-2 text-xs md:text-sm font-medium text-slate-600 whitespace-nowrap">
                        <i class="fa-solid fa-sliders ml-1"></i> בנה תרחיש
                    </button>
                    <button onclick="switchView('map')" id="nav-map" class="nav-item px-2 py-2 text-xs md:text-sm font-medium text-slate-600 whitespace-nowrap">
                        <i class="fa-solid fa-map-location-dot ml-1"></i> מפה
                    </button>
                    <button onclick="switchView('details')" id="nav-details" class="nav-item px-2 py-2 text-xs md:text-sm font-medium text-slate-600 whitespace-nowrap">
                        <i class="fa-solid fa-city ml-1"></i> פירוט
                    </button>
                    <button onclick="switchView('report')" id="nav-report" class="nav-item px-2 py-2 text-xs md:text-sm font-medium text-slate-600 whitespace-nowrap">
                        <i class="fa-solid fa-file-contract ml-1"></i> דו"ח מלא
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 md:py-8">

        <!-- VIEW 1: DASHBOARD & SENSITIVITY -->
        <div id="view-dashboard" class="animate-fade-in space-y-6">
            
            <!-- Recommendations Banner -->
            <div class="bg-white rounded-lg shadow-sm p-4 border-r-4 border-primary bg-gradient-to-l from-blue-50 to-white">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="md:w-3/4">
                        <h2 class="text-xl font-bold text-primary mb-1">המלצה אסטרטגית (מעודכן V2)</h2>
                        <p class="text-slate-700 text-sm leading-relaxed">
                            החלופה המובילה: <strong>פתח תקווה (רמת סיב)</strong> (ציון 8.75).
                            <br>
                            חלופה שנייה: <strong>ראשון לציון</strong> (8.15) - עקפה את מודיעין לאור נתוני הרק"ל.
                            <br>
                            <span class="font-bold text-slate-900">החלטה נדרשת:</span> פנייה דיסקרטית לקבלת הצעות (פ"ת, ראשל"צ, מודיעין, ב"ב).
                        </p>
                    </div>
                    <div class="flex gap-4 md:w-1/4 justify-end w-full border-t md:border-t-0 pt-2 md:pt-0">
                        <div class="text-center">
                            <span class="block text-xl font-bold text-green-600">50%</span>
                            <span class="text-[10px] text-slate-500">חיסכון מול ת"א</span>
                        </div>
                        <div class="text-center border-r border-slate-200 pr-4">
                            <span class="block text-xl font-bold text-blue-600">8.75</span>
                            <span class="text-[10px] text-slate-500">ציון משוקלל (פ"ת)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scenario Selector -->
            <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200">
                <h2 class="text-base font-bold text-slate-800 mb-3 flex items-center">
                    <i class="fa-solid fa-sliders text-secondary ml-2"></i>
                    בחר תרחיש לבחינה:
                </h2>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">
                    <button onclick="setScenario('base')" id="btn-base" class="scenario-btn active border rounded-md p-2 text-right h-full">
                        <div class="font-bold text-slate-800 text-sm">בסיס (מאוזן)</div>
                        <div class="text-[10px] text-slate-500 leading-tight">המלצת מטה</div>
                    </button>
                    <button onclick="setScenario('south')" id="btn-south" class="scenario-btn border rounded-md p-2 text-right h-full">
                        <div class="font-bold text-slate-800 text-sm">הרוב הדרומי</div>
                        <div class="text-[10px] text-slate-500 leading-tight">אשדוד/יבנה</div>
                    </button>
                    <button onclick="setScenario('car')" id="btn-car" class="scenario-btn border rounded-md p-2 text-right h-full">
                        <div class="font-bold text-slate-800 text-sm">העובד הנוהג</div>
                        <div class="text-[10px] text-slate-500 leading-tight">דגש רכב</div>
                    </button>
                    <button onclick="setScenario('budget')" id="btn-budget" class="scenario-btn border rounded-md p-2 text-right h-full">
                        <div class="font-bold text-slate-800 text-sm">חיסכון</div>
                        <div class="text-[10px] text-slate-500 leading-tight">מחיר קובע</div>
                    </button>
                    <button onclick="setScenario('prestige')" id="btn-prestige" class="scenario-btn border rounded-md p-2 text-right h-full">
                        <div class="font-bold text-slate-800 text-sm">יוקרה</div>
                        <div class="text-[10px] text-slate-500 leading-tight">תדמית</div>
                    </button>
                    <button onclick="setScenario('north')" id="btn-north" class="scenario-btn border rounded-md p-2 text-right h-full">
                        <div class="font-bold text-slate-800 text-sm">הרוב הצפוני</div>
                        <div class="text-[10px] text-slate-500 leading-tight">השרון</div>
                    </button>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Main Score Chart -->
                <div class="lg:col-span-2 bg-white rounded-xl shadow-sm p-4 border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700 text-sm md:text-base">השוואת ציונים משוקללת</h3>
                        <button onclick="toggleDrillDown()" class="text-xs bg-slate-100 hover:bg-slate-200 text-primary px-3 py-1 rounded-full transition">
                            <i class="fa-solid fa-table ml-1"></i> הצג טבלת ציונים מפורטת
                        </button>
                    </div>
                    
                    <!-- Chart -->
                    <div class="chart-container mb-4">
                        <canvas id="mainChart"></canvas>
                    </div>

                    <!-- Hidden Drilldown Table -->
                    <div id="drilldown-container" class="hidden border-t border-slate-100 pt-4 mt-4 bg-slate-50 rounded-lg p-2 overflow-x-auto">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-xs font-bold text-slate-500">פירוט ציונים גולמיים (לפני משקולות)</h4>
                            <div class="flex gap-2">
                                <button onclick="resetScores()" class="text-[10px] bg-red-50 text-red-600 px-2 py-1 rounded border border-red-100 hover:bg-red-100">
                                    <i class="fa-solid fa-rotate-left"></i> אפס ברירת מחדל
                                </button>
                                <button id="btn-edit-scores" onclick="toggleEditMode()" class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100 hover:bg-blue-100 font-bold">
                                    <i class="fa-solid fa-pen"></i> ערוך ציונים
                                </button>
                            </div>
                        </div>
                        <table class="w-full text-xs text-right whitespace-nowrap">
                            <thead class="bg-slate-200 text-slate-600">
                                <tr>
                                    <th class="p-2">עיר</th>
                                    <th class="p-2 text-center">רק"ל</th>
                                    <th class="p-2 text-center">רכבת</th>
                                    <th class="p-2 text-center">רכב</th>
                                    <th class="p-2 text-center">אוטובוס</th>
                                    <th class="p-2 text-center">חניה</th>
                                    <th class="p-2 text-center">עלות</th>
                                    <th class="p-2 text-center">איכות</th>
                                </tr>
                            </thead>
                            <tbody id="drilldown-body" class="divide-y divide-slate-200">
                                <!-- Injected via JS -->
                            </tbody>
                        </table>
                        <p class="text-[10px] text-slate-400 mt-2" id="edit-hint">* לחץ על "ערוך ציונים" כדי לשנות את הערכים בטבלה. השינוי ישפיע מידית על כל הדשבורד.</p>
                    </div>
                </div>

                <!-- Cost Chart & Data -->
                <div class="lg:col-span-1 space-y-4">
                    <!-- Cost Card -->
                    <div class="bg-white rounded-xl shadow-sm p-4 border-t-4 border-green-500">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-slate-700 text-sm">עלות שנתית (מלש"ח)</h3>
                            <button onclick="toggleCostTable()" class="text-xs text-blue-600 underline">טבלה מלאה</button>
                        </div>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="costChart"></canvas>
                        </div>
                        
                        <!-- Hidden Cost Table -->
                        <div id="cost-table-container" class="hidden mt-4 text-xs">
                            <div class="overflow-x-auto">
                                <table class="w-full text-right border-collapse">
                                    <thead class="bg-slate-100">
                                        <tr>
                                            <th class="p-1 border">עיר</th>
                                            <th class="p-1 border">שכירות</th>
                                            <th class="p-1 border">ניהול</th>
                                            <th class="p-1 border">ארנונה</th>
                                            <th class="p-1 border font-bold">סה"כ</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y">
                                        <tr><td class="p-1">ת"א</td><td class="p-1">135</td><td class="p-1">24</td><td class="p-1">34</td><td class="p-1 font-bold">193</td></tr>
                                        <tr><td class="p-1">ר"ג</td><td class="p-1">120</td><td class="p-1">24</td><td class="p-1">31</td><td class="p-1 font-bold">175</td></tr>
                                        <tr><td class="p-1">הרצליה</td><td class="p-1">115</td><td class="p-1">22</td><td class="p-1">30</td><td class="p-1 font-bold">167</td></tr>
                                        <tr><td class="p-1">ב"ב</td><td class="p-1">75</td><td class="p-1">20</td><td class="p-1">28</td><td class="p-1 font-bold">123</td></tr>
                                        <tr><td class="p-1">ראשל"צ</td><td class="p-1">75</td><td class="p-1">20</td><td class="p-1">25</td><td class="p-1 font-bold">120</td></tr>
                                        <tr><td class="p-1">פ"ת</td><td class="p-1">65</td><td class="p-1">18</td><td class="p-1">25</td><td class="p-1 font-bold">108</td></tr>
                                        <tr><td class="p-1">מודיעין</td><td class="p-1">60</td><td class="p-1">16</td><td class="p-1">18</td><td class="p-1 font-bold">94</td></tr>
                                    </tbody>
                                </table>
                                <p class="text-[10px] text-slate-400 mt-1">* מחיר למ"ר לחודש בש"ח</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 2: CUSTOM SCENARIO BUILDER (Compact Design) -->
        <div id="view-custom" class="hidden animate-fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-full">
                
                <!-- Controls Column -->
                <div class="lg:col-span-4 bg-white rounded-xl shadow-md p-4 h-fit">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-slate-800 text-lg leading-none">בניית תרחיש</h3>
                            <div class="text-xs text-slate-500 mt-1">
                                סה"כ ניקוד: <span id="total-weight" class="font-bold text-primary">100%</span> (מתנרמל אוטומטית)
                            </div>
                        </div>
                        <button onclick="resetCustomSliders()" class="text-xs text-slate-500 hover:text-primary"><i class="fa-solid fa-rotate-right"></i> איפוס</button>
                    </div>
                    
                    <div id="sliders-container" class="space-y-3">
                        <!-- Sliders injected by JS (Compact mode) -->
                    </div>
                </div>

                <!-- Results Column -->
                <div class="lg:col-span-8 flex flex-col gap-4">
                    <!-- Live Chart -->
                    <div class="bg-white rounded-xl shadow-md p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-slate-700 text-sm">תוצאות בזמן אמת</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="customChart"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- VIEW 3: MAP VISUALIZATION -->
        <div id="view-map" class="hidden animate-fade-in h-full">
            <div class="card h-full flex flex-col">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800">מפת החלופות בגוש דן והשפלה</h3>
                    <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded">לחץ על סמן לצפייה בפרטים</span>
                </div>
                <div class="flex-grow p-1">
                    <div id="map"></div>
                </div>
            </div>
        </div>

        <!-- VIEW 4: CITY DETAILS -->
        <div id="view-details" class="hidden animate-fade-in">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                
                <!-- Sidebar Menu (Mobile Horizontal / Desktop Vertical) -->
                <div class="md:col-span-3 flex md:flex-col overflow-x-auto md:overflow-visible gap-2 pb-2 md:pb-0">
                    <!-- Dynamic Buttons -->
                    <button onclick="renderCityDetail('pt')" class="city-nav-btn min-w-[120px] md:min-w-0 md:w-full text-right p-3 rounded-lg bg-white shadow-sm border-r-4 border-green-500 hover:bg-slate-50 transition">
                        <span class="font-bold text-slate-700 text-sm block">פתח תקווה</span>
                        <span class="text-[10px] text-slate-400 hidden md:block">הבחירה הכלכלית</span>
                    </button>
                    <button onclick="renderCityDetail('rishon')" class="city-nav-btn min-w-[120px] md:min-w-0 md:w-full text-right p-3 rounded-lg bg-white shadow-sm border-r-4 border-blue-500 hover:bg-slate-50 transition">
                        <span class="font-bold text-slate-700 text-sm block">ראשון לציון</span>
                        <span class="text-[10px] text-slate-400 hidden md:block">אסטרטגי לדרום</span>
                    </button>
                    <button onclick="renderCityDetail('modiin')" class="city-nav-btn min-w-[120px] md:min-w-0 md:w-full text-right p-3 rounded-lg bg-white shadow-sm border-r-4 border-indigo-500 hover:bg-slate-50 transition">
                        <span class="font-bold text-slate-700 text-sm block">מודיעין</span>
                    </button>
                    <button onclick="renderCityDetail('bbc')" class="city-nav-btn min-w-[120px] md:min-w-0 md:w-full text-right p-3 rounded-lg bg-white shadow-sm border-r-4 border-yellow-500 hover:bg-slate-50 transition">
                        <span class="font-bold text-slate-700 text-sm block">בני ברק</span>
                    </button>
                    <button onclick="renderCityDetail('tlv')" class="city-nav-btn min-w-[120px] md:min-w-0 md:w-full text-right p-3 rounded-lg bg-white shadow-sm border-r-4 border-red-500 hover:bg-slate-50 transition">
                        <span class="font-bold text-slate-700 text-sm block">תל אביב</span>
                    </button>
                    <button onclick="renderCityDetail('bursa')" class="city-nav-btn min-w-[120px] md:min-w-0 md:w-full text-right p-3 rounded-lg bg-white shadow-sm border-r-4 border-orange-500 hover:bg-slate-50 transition">
                        <span class="font-bold text-slate-700 text-sm block">בורסה</span>
                    </button>
                    <button onclick="renderCityDetail('sharon')" class="city-nav-btn min-w-[120px] md:min-w-0 md:w-full text-right p-3 rounded-lg bg-white shadow-sm border-r-4 border-pink-500 hover:bg-slate-50 transition">
                        <span class="font-bold text-slate-700 text-sm block">השרון</span>
                    </button>
                </div>

                <!-- Detail Content Area -->
                <div class="md:col-span-9">
                    <div id="city-content" class="bg-white rounded-xl shadow-md p-6 h-full">
                        <!-- Content injected via JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW 5: FULL REPORT (PASSWORD PROTECTED) -->
        <div id="view-report" class="hidden animate-fade-in">
            <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-md p-4 md:p-8 border border-slate-200">
                
                <!-- Password Protection UI -->
                <div id="report-auth" class="flex flex-col items-center justify-center py-12 space-y-4">
                    <div class="text-center">
                        <i class="fa-solid fa-lock text-4xl text-slate-300 mb-2"></i>
                        <h3 class="text-lg font-bold text-slate-700">דוח זה מוגן בסיסמה</h3>
                        <p class="text-sm text-slate-500">אנא הזן את קוד הגישה לצפייה בתוכן המלא.</p>
                    </div>
                    <div class="flex gap-2 w-full max-w-xs">
                        <input type="password" id="report-password" placeholder="סיסמה" class="flex-grow border border-slate-300 rounded px-3 py-2 text-sm focus:outline-none focus:border-primary">
                        <button onclick="checkReportPassword()" class="bg-primary text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 transition">פתח</button>
                    </div>
                    <p id="password-error" class="text-xs text-red-500 hidden">סיסמה שגויה. נסה שנית.</p>
                </div>

                <!-- Actual Report Content (Hidden initially) -->
                <div id="report-content-body" class="hidden report-content">
                    <div class="border-b-2 border-primary pb-4 mb-6">
                        <h1 class="text-2xl font-bold text-primary">מסמך עמדה: בחינת חלופות אסטרטגיות להעתקת מטה החברה</h1>
                        <div class="mt-2 text-sm text-slate-500 flex flex-col md:flex-row justify-between">
                            <div><strong>אל:</strong> מנכ"ל החברה</div>
                            <div><strong>מאת:</strong> סמנכ"ל נכסים</div>
                            <div><strong>תאריך:</strong> 11 בדצמבר 2025</div>
                            <div><strong>הנדון:</strong> דוח ניתוח חלופות (Site Selection Analysis)</div>
                        </div>
                    </div>

                    <h2>1. תקציר מנהלים</h2>
                    <p>מסמך זה מציג את עבודת המטה שבוצעה בחטיבת הנכסים לבחינת חלופות להעתקת משרדי הנהלת החברה (מטה) ממיקומם הנוכחי בת"א. המהלך נועד להתאים את סביבת העבודה לצרכים העדכניים של החברה, לשפר את הנגישות לעובדים ולאורחים, ולמקסם את היעילות הכלכלית.</p>
                    <div class="bg-blue-50 p-4 border-r-4 border-blue-500 rounded my-4">
                        <strong>החלטה נדרשת:</strong> אישור לביצוע סקר מגורים ממוכן לכלל עובדי המטה, ואישור לצאת בפניה דיסקרטית בארבע חלופות נבחרות: פתח תקווה, ראשון לציון, מודיעין ובני ברק.
                    </div>
                    <p>במסגרת העבודה נותחו 7 מתחמי תעסוקה מרכזיים בגוש דן והשפלה. הניתוח התבסס על מודל משוקלל המעניק עדיפות לנגישות תחבורתית מגוונת ולחוויית העובד. המסקנה המרכזית היא כי חלופת <strong>פתח-תקווה (רמת סיב)</strong> מספקת את המענה המיטבי (ציון 8.75) לכלל העובדים. <strong>ראשון לציון</strong> הינה החלופה השנייה בטיבה בתרחיש הבסיס (8.15), במיוחד אם יתברר כי קיים רוב לעובדים המתגוררים בדרום.</p>

                    <h2>2. הגדרת הפרוגרמה והצרכים</h2>
                    <p>על בסיס ניתוח ראשוני של מצבת כוח האדם וצרכי החברה, הוגדרו עקרונות הבסיס לאיתור:</p>
                    <ul>
                        <li><strong>היקף השטח:</strong> כ-5,000 מ"ר (ברוטו). שטח זה מאפשר יחס ברוטו לעובד של כ-33 מ"ר, הכולל רווחה נדיבה, חדרי ישיבות מרובים ושטחי ציבור.</li>
                        <li><strong>אוכלוסייה:</strong> כ-150 עובדים (הנהלה, כספים, משפטית, נכסים, הנדסה).</li>
                        <li><strong>תצורה:</strong> עדיפות לקומות גדולות (Floor Plate של 1,500 מ"ר ומעלה) לשמירה על רצף ניהולי וסנכרון בין מחלקות.</li>
                        <li><strong>נגישות:</strong> דרישה ל"תמהיל תחבורה מלא" – דגש על רכבת קלה (רק"ל) ורכבת כבדה, לצד נגישות לרכב פרטי.</li>
                    </ul>

                    <h2>3. מתודולוגיית הדירוג (מודל המשקולות)</h2>
                    <p>הניקוד לכל חלופה ניתן על בסיס המשקולות הבאים:</p>
                    <div class="report-table-wrapper">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>קטגוריה</th>
                                    <th>פרמטר</th>
                                    <th>משקל</th>
                                    <th>רציונל</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td rowspan="3">תחבורה ציבורית (40%)</td>
                                    <td>רכבת קלה (רק"ל)</td>
                                    <td>15%</td>
                                    <td>אמצעי הניידות המרכזי והאמין במטרופולין.</td>
                                </tr>
                                <tr>
                                    <td>רכבת כבדה</td>
                                    <td>15%</td>
                                    <td>קריטי לעובדים המגיעים מהפריפריה (חיפה/אשדוד).</td>
                                </tr>
                                <tr>
                                    <td>אוטובוסים</td>
                                    <td>10%</td>
                                    <td>רשת משלימה וגיבוי לרכבות.</td>
                                </tr>
                                <tr>
                                    <td rowspan="2">רכב וחניה (20%)</td>
                                    <td>נגישות כבישים</td>
                                    <td>15%</td>
                                    <td>קרבה לצירים ארציים (איילון/4/431).</td>
                                </tr>
                                <tr>
                                    <td>הקצאת חניות</td>
                                    <td>5%</td>
                                    <td>גמישות תפעולית (הסתמכות על פתרונות היקפיים).</td>
                                </tr>
                                <tr>
                                    <td>כלכלי (15%)</td>
                                    <td>עלויות שוטפות</td>
                                    <td>15%</td>
                                    <td>שכ"ד, ניהול וארנונה.</td>
                                </tr>
                                <tr>
                                    <td>שוק (10%)</td>
                                    <td>זמינות והיצע</td>
                                    <td>10%</td>
                                    <td>כוח מיקוח וכניסה מהירה.</td>
                                </tr>
                                <tr>
                                    <td rowspan="2">איכות ורווחה (15%)</td>
                                    <td>איכות וגמישות תפעולית</td>
                                    <td>10%</td>
                                    <td>מפרט הבניין, גודל קומה, מערכות.</td>
                                </tr>
                                <tr>
                                    <td>סביבת עבודה</td>
                                    <td>5%</td>
                                    <td>מסעדות, שירותים בקרבת מקום, אווירה.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h2>4. חלופות אסטרטגיות שנבחנו</h2>
                    <ul>
                        <li><strong>חלופה א':</strong> תל אביב – ציר יגאל אלון / ביצרון (מגדלי טויוטה, אלקטרה, תוצרת הארץ).</li>
                        <li><strong>חלופה ב':</strong> רמת גן – מתחם הבורסה (אזור מגדל השחר, אטריום, סבידור).</li>
                        <li><strong>חלופה ג':</strong> בני ברק – מתחם ה-BBC (צפון בני ברק, מגדלי ב.ס.ר).</li>
                        <li><strong>חלופה ד':</strong> פתח תקווה – רמת סיב / קריית אריה (אזור גלובל טאוורס, ב.ס.ר סיטי).</li>
                        <li><strong>חלופה ה':</strong> ראשון לציון – מתחם האלף (מערב ראשל"צ).</li>
                        <li><strong>חלופה ו':</strong> מודיעין – ליגד / מע"ר.</li>
                        <li><strong>חלופה ז':</strong> אזור השרון – הרצליה פיתוח / רעננה צפון.</li>
                    </ul>

                    <h2>5. ניתוח עומק השוואתי (Data Breakdown)</h2>
                    
                    <h3>5.1 ניתוח עלויות מפורט: שכירות, ניהול וארנונה (אומדן 2025)</h3>
                    <p>בצענו ניתוח שוק על בסיס נתוני אמת והצעות מחיר ראשוניות (Asking Price) למשרדים ברמת גמר מלא (Class A) בשטח של כ-5,000 מ"ר. הנתונים להלן כוללים שקלול של דמי שכירות, דמי ניהול ותשלומי ארנונה (לפי תעריפי 2024/5):</p>
                    
                    <div class="report-table-wrapper">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>פרמטר</th>
                                    <th>תל אביב</th>
                                    <th>רמת גן</th>
                                    <th>בני ברק</th>
                                    <th>פתח תקווה</th>
                                    <th>ראשל"צ</th>
                                    <th>מודיעין</th>
                                    <th>הרצליה פיתוח</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>שכירות למ"ר (הערכה)</td>
                                    <td>135 ₪</td>
                                    <td>120 ₪</td>
                                    <td>75 ₪</td>
                                    <td>65 ₪</td>
                                    <td>75 ₪</td>
                                    <td>60 ₪</td>
                                    <td>115 ₪</td>
                                </tr>
                                <tr>
                                    <td>דמי ניהול למ"ר</td>
                                    <td>24 ₪</td>
                                    <td>24 ₪</td>
                                    <td>20 ₪</td>
                                    <td>18 ₪</td>
                                    <td>20 ₪</td>
                                    <td>16 ₪</td>
                                    <td>22 ₪</td>
                                </tr>
                                <tr>
                                    <td>ארנונה למ"ר (חודשי*)</td>
                                    <td>~34 ₪</td>
                                    <td>~31 ₪</td>
                                    <td>~28 ₪</td>
                                    <td>~25 ₪</td>
                                    <td>~25 ₪</td>
                                    <td>~18 ₪</td>
                                    <td>~30 ₪</td>
                                </tr>
                                <tr class="font-bold bg-slate-100">
                                    <td>סה"כ למ"ר לחודש</td>
                                    <td>193 ₪</td>
                                    <td>175 ₪</td>
                                    <td>123 ₪</td>
                                    <td>108 ₪</td>
                                    <td>120 ₪</td>
                                    <td>94 ₪</td>
                                    <td>167 ₪</td>
                                </tr>
                                <tr>
                                    <td>סה"כ חודשי (5,000 מ"ר)</td>
                                    <td>965,000 ₪</td>
                                    <td>875,000 ₪</td>
                                    <td>615,000 ₪</td>
                                    <td>540,000 ₪</td>
                                    <td>600,000 ₪</td>
                                    <td>470,000 ₪</td>
                                    <td>835,000 ₪</td>
                                </tr>
                                <tr class="font-bold text-primary">
                                    <td>עלות שנתית כוללת</td>
                                    <td>11.6 מלש"ח</td>
                                    <td>10.5 מלש"ח</td>
                                    <td>7.4 מלש"ח</td>
                                    <td>6.5 מלש"ח</td>
                                    <td>7.2 מלש"ח</td>
                                    <td>5.6 מלש"ח</td>
                                    <td>10.0 מלש"ח</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p class="text-xs text-slate-500 mb-4">*הערה: המספרים לעיל מהווים אומדן להשוואה בין-עירונית ואינם מהווים חלופה לבדיקה פרטנית של כל נכס, שתבוצע בשלב מו"מ. הטווחים עשויים לנוע בשיעור של ±10% בהתאם לסיווג הנכס המדויק ואזור המס הספציפי.</p>
                    <p><strong>משמעויות כלכליות:</strong> המעבר למודיעין או לפתח תקווה משקף חיסכון שנתי של כ-5 עד 6 מיליון ש"ח (כ-50% מעלות הדיור) בהשוואה להישארות בתל אביב. בנוסף, עלות החניה בפריפריה נמוכה בכ-50% מאשר בתל אביב, חיסכון נוסף של כמיליון ש"ח בשנה.</p>

                    <h3>5.2 נגישות רכבתית (קלה וכבדה)</h3>
                    <ul>
                        <li><strong>פתח תקווה (רמת סיב):</strong> נגישות מצוינת לרכבת הקלה (הקו האדום - תחנות שנקר/שחם/בלינסון בלב אזורי התעסוקה). הנגישות לרכבת כבדה (תחנת קריית אריה) טובה לחלק הצפוני, ודורשת קישורית מאזור רמת סיב הדרומי.</li>
                        <li><strong>רמת גן (הבורסה):</strong> הציון הגבוה ביותר. שילוב מנצח של רכבת כבדה ("סבידור מרכז" - ה-Hub הראשי של ישראל) ורכבת קלה (תחנת "אבא הלל" של הקו האדום) במרחק הליכה מיידי.</li>
                        <li><strong>תל אביב (יגאל אלון):</strong> נגישות טובה לרכבת כבדה (תחנת "השלום" במרחק הליכה של כ-8-10 דקות). נגישות בינונית לרכבת הקלה (תחנות הקו האדום "יהודית" או "שאול המלך" במרחק הליכה של כ-10-12 דקות).</li>
                        <li><strong>בני ברק (BBC):</strong> נגישות מצוינת לרכבת הקלה (תחנות "בן גוריון" ו"אהרונוביץ'" של הקו האדום). נגישות נמוכה לרכבת כבדה (תחנת "בני ברק" ממוקמת בקצה הצפוני ודורשת הליכה ארוכה או שאטל), יש אוטובוסים גם מתחנת הבורסה.</li>
                        <li><strong>ראשון לציון (מתחם האלף):</strong> נגישות מצוינת לרכבת כבדה (תחנת "משה דיין" צמודה למתחם, קו מהיר לת"א ולדרום). חיסרון מהותי: אין כרגע רכבת קלה פעילה (הקו הירוק בבנייה, צפי הפעלה 2028).</li>
                        <li><strong>מודיעין:</strong> מצטיינת ברכבת כבדה מהירה לת"א (כ-25 דקות) ולירושלים (כ-20 דקות) מתחנות "פאתי מודיעין" (אזור ליגד) ו"מודיעין מרכז" (מע"ר). ציון 0 בנגישות רכבת קלה - אין מענה רק"ל קיים או מתוכנן בטווח הזמן הרלוונטי.</li>
                        <li><strong>אזור השרון:</strong> רכבת כבדה קיימת (דורשת שאטל למרכזי התעסוקה). אין מענה רק"ל בטווח הקרוב.</li>
                    </ul>

                    <h3>5.3 נגישות כבישים ואוטובוסים</h3>
                    <ul>
                        <li><strong>מתחם האלף (ראשל"צ):</strong> הציון הגבוה ביותר. ממוקם על מחלף ייעודי המחבר ישירות את נתיבי איילון דרום (כביש 20) וכביש 431. מאפשר לעובדי הדרום והשפלה לעצור "לפני הפקק" הגדול של גוש דן.</li>
                        <li><strong>תל אביב (יגאל אלון):</strong> ירידה נוחה יחסית מאיילון, אך ציר יגאל אלון עצמו ורחובות הגישה סובלים מעומסי תנועה כבדים מאוד בשעות הבוקר והערב. אוטובוסים: נגישות מצוינת.</li>
                        <li><strong>רמת גן (הבורסה):</strong> "צוואר בקבוק" לרכב פרטי. הכניסה והיציאה למתחם כרוכה בעמידה ממושכת בפקקים. אוטובוסים: הציון הגבוה ביותר (מסוף 2000).</li>
                        <li><strong>בני ברק (BBC):</strong>
                            <ul class="list-none pl-0">
                                <li><strong>כבישים:</strong> גישה סבירה מכביש 4 (מחלף אם המושבות/ז'בוטינסקי), אך המתחם הפנימי (רחובות הירקון/בן גוריון) צפוף וקשה לתנועה.</li>
                                <li><strong>אוטובוסים:</strong> נגישות טובה מאוד. נהנה מהשירות האינטנסיבי על ציר ז'בוטינסקי ודרך בן גוריון.</li>
                            </ul>
                        </li>
                        <li><strong>פתח תקווה (רמת סיב):</strong> מיקום אסטרטגי (כביש 4, 5, 471), אך עומסים בכניסות לעיר (ז'בוטינסקי/רבין) בבקרים. אוטובוסים: נגישות טובה מאוד.</li>
                        <li><strong>מודיעין (ליגד/מע"ר):</strong> נגישות פנומנלית לרכב פרטי דרך כביש 431 וכביש 1. הפארק הטכנולוגי מרווח וללא פקקי תנועה פנימיים.</li>
                        <li><strong>אזור השרון (הרצליה/רעננה):</strong> אתגר קשה לעובדים הגרים מדרום לגלילות. ההגעה בבוקר מחייבת חצייה של כל נתיבי איילון/כביש 4 לכיוון צפון.</li>
                    </ul>

                    <h3>5.4 איכות, גמישות תפעולית וסביבת עבודה</h3>
                    <ul>
                        <li><strong>תל אביב - ציר יגאל אלון (ציון: 9.5 משוקלל):</strong>
                            <ul class="list-none pl-0">
                                <li><strong>איכות המבנה:</strong> מגדלי Class A+ אייקוניים (כגון מגדלי אלון, אלקטרה, תוצרת הארץ). לובי מפואר, שמירה 24/7, ומערכות ניהול מתקדמות.</li>
                                <li><strong>סביבת עבודה:</strong> הציון הגבוה ביותר בישראל. סביבה אורבנית שוקקת ("עירוב שימושים" אמיתי). שפע מסעדות מכל הסוגים במרחק הליכה, בתי קפה, מכוני כושר, וגישה רגלית למתחם שרונה ועזריאלי. האזור פעיל ותוסס גם בשעות הערב.</li>
                            </ul>
                        </li>
                        <li><strong>פתח תקווה - רמת סיב (ציון: 8.0 משוקלל):</strong>
                            <ul class="list-none pl-0">
                                <li><strong>איכות המבנה:</strong> תנופת בנייה חדשה ומודרנית (גלובל טאוורס, ב.ס.ר סיטי). היתרון האסטרטגי הוא גודל הקומה (Floor Plate): קומות ענק של 1,500-2,500 מ"ר המאפשרות לרכז את כל המטה ב-2-3 קומות בלבד, מה שמייעל את התקשורת הארגונית וחוסך שטחי שירות כפולים.</li>
                                <li><strong>סביבת עבודה:</strong> פונקציונלית מאוד ("אזור תעשייה משודרג"). קיימים מתחמי הסעדה ובילוי ייעודיים המספקים פתרון, אך האזור פחות "הליכתי" ומרגיש מנותק בשעות הערב.</li>
                            </ul>
                        </li>
                        <li><strong>ראשון לציון - מתחם האלף (ציון: 7.5 משוקלל):</strong>
                            <ul class="list-none pl-0">
                                <li><strong>איכות המבנה:</strong> הציון הגבוה ביותר לאיכות הבנייה (10/10). כלל הבניינים הם חדשים לחלוטין ("מהניילונים"), נבנו בתקן ירוק (LEED) מחמיר, ומציעים תשתיות תקשורת ומערכות חכמות מתקדמות ביותר. קומות ענק מרווחות.</li>
                                <li><strong>סביבת עבודה:</strong> עדיין בשלבי פיתוח ראשוניים. ההיצע הקולינרי מוגבל כרגע לקפיטריות בתוך הבניינים או למתחמי קניות סמוכים (קניון הזהב/סינמה סיטי) המצריכים רכב או שאטל. חסרה תחושת "רחוב" והליכה ספונטנית.</li>
                            </ul>
                        </li>
                        <li><strong>רמת גן - מתחם הבורסה (ציון: 8.0 משוקלל):</strong>
                            <ul class="list-none pl-0">
                                <li><strong>איכות המבנה:</strong> מלאי מעורב מאוד. לצד מגדלים חדשים ונוצצים (אטריום, ספיר), ישנם בניינים ותיקים רבים עם קומות קטנות (כ-1,000 מ"ר) וריבוי עמודים, המקשים על תכנון Open Space יעיל ומחייבים פיצול החברה למספר רב של קומות.</li>
                                <li><strong>סביבת עבודה:</strong> סביבה אינטנסיבית ושוקקת חיים. היצע אדיר וזמין של מסעדות פועלים ומזון מהיר, אך האזור סובל מצפיפות גבוהה, רעש, וזיהום אוויר, והוא פחות "מזמין" להליכה נינוחה או לאירוח יוקרתי.</li>
                            </ul>
                        </li>
                        <li><strong>אזור השרון - הרצליה פיתוח (ציון: 9.5 משוקלל):</strong>
                            <ul class="list-none pl-0">
                                <li><strong>איכות המבנה:</strong> מבנים איכותיים מאוד, שילוב של מגדלים וקמפוסים נמוכים ומטופחים.</li>
                                <li><strong>סביבת עבודה:</strong> סביבת העבודה היוקרתית בישראל. מסעדות גורמה, קרבה לים, מלונות עסקים ואווירה בינלאומית. החיסרון הוא עלויות המחיה הגבוהות (מסעדות, חניה) והריחוק עבור עובדי הדרום.</li>
                            </ul>
                        </li>
                        <li><strong>מודיעין - ליגד/מע"ר (ציון: 8.0 משוקלל):</strong>
                            <ul class="list-none pl-0">
                                <li><strong>איכות המבנה:</strong> מבנים חדשים, קמפוסים מרווחים ונוף פתוח. צפיפות נמוכה המאפשרת רווחה לעובד.</li>
                                <li><strong>סביבת עבודה:</strong> במע"ר החדש - מצוינת (צמוד לקניון עזריאלי, רכבת ושדרת חנויות). באזור הפארק הטכנולוגי (ליגד) - הסביבה מבודדת יותר ומסתמכת בעיקר על שירותי הסעדה פנימיים בתוך המתחם.</li>
                            </ul>
                        </li>
                        <li><strong>בני ברק - BBC (ציון: 7.0 משוקלל):</strong>
                            <ul class="list-none pl-0">
                                <li><strong>איכות המבנה:</strong> מגדלים חדשים יחסית (בעיקר קבוצת ב.ס.ר), איכות טובה ומחיר תחרותי.</li>
                                <li><strong>סביבת עבודה:</strong> פונקציונלית ועמוסה. היצע סביר של מסעדות (בעיקר כשרות למהדרין), אך האזור סובל מצפיפות ועומסי תנועה כבדים בתוך הרחובות הצרים של המתחם.</li>
                            </ul>
                        </li>
                    </ul>

                    <h2>6. טבלת דירוג משוקללת (תרחיש בסיס) - מעודכן</h2>
                    <div class="report-table-wrapper">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>פרמטר לבחינה</th>
                                    <th>משקל</th>
                                    <th>תל אביב</th>
                                    <th>הבורסה</th>
                                    <th>בני ברק</th>
                                    <th>פתח תקווה</th>
                                    <th>ראשל"צ</th>
                                    <th>מודיעין</th>
                                    <th>השרון</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>1</td><td>רכבת קלה</td><td>15%</td><td>7</td><td>10</td><td>9</td><td>10</td><td>6</td><td>0</td><td>2</td></tr>
                                <tr><td>2</td><td>רכבת כבדה</td><td>15%</td><td>9</td><td>10</td><td>6</td><td>7</td><td>10</td><td>10</td><td>8</td></tr>
                                <tr><td>3</td><td>נגישות כבישים</td><td>15%</td><td>7</td><td>4</td><td>6</td><td>7</td><td>9</td><td>10</td><td>5</td></tr>
                                <tr><td>4</td><td>קווי אוטובוס</td><td>10%</td><td>9</td><td>10</td><td>9</td><td>9</td><td>6</td><td>7</td><td>8</td></tr>
                                <tr><td>5</td><td>הקצאת חניות</td><td>5%</td><td>3</td><td>2</td><td>6</td><td>10</td><td>10</td><td>10</td><td>8</td></tr>
                                <tr><td>6</td><td>עלויות</td><td>15%</td><td>5</td><td>4</td><td>8</td><td>10</td><td>8</td><td>10</td><td>6</td></tr>
                                <tr><td>7</td><td>זמינות והיצע</td><td>10%</td><td>6</td><td>7</td><td>8</td><td>10</td><td>9</td><td>9</td><td>7</td></tr>
                                <tr><td>8</td><td>איכות וגמישות</td><td>10%</td><td>9</td><td>7</td><td>7</td><td>9</td><td>9</td><td>9</td><td>9</td></tr>
                                <tr><td>9</td><td>סביבת עבודה</td><td>5%</td><td>10</td><td>9</td><td>6</td><td>7</td><td>6</td><td>7</td><td>10</td></tr>
                                <tr class="font-bold bg-slate-200 text-primary">
                                    <td colspan="2">ציון סופי</td><td>100%</td><td>7.25</td><td>7.15</td><td>7.35</td><td>8.75</td><td>8.15</td><td>7.90</td><td>7.05</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <h2>7. ניתוח רגישות (Sensitivity Analysis)</h2>
                    <p>כלי ניהולי זה נועד לבחון את "יציבות" ההמלצה. להלן פירוט 5 תרחישי קיצון:</p>
                    
                    <h3>7.1 תרחיש א': "העובד הנוהג" (Car Oriented)</h3>
                    <p><strong>ההנחה:</strong> הנהלת החברה מחליטה שרכב פרטי הוא אמצעי ההגעה העיקרי לרוב העובדים, וחובה לספק חניה צמודה לכולם.</p>
                    <p><strong>התוצאה:</strong> מודיעין חזקה מאוד (9.00), אך הפער מצטמצם. ראשון לציון (8.90) צמודה אליה מאוד בפסגה. תל אביב והבורסה נותרות בתחתית.</p>

                    <h3>7.2 תרחיש ב': "חיסכון אגרסיבי" (Budget Crisis)</h3>
                    <p><strong>ההנחה:</strong> החברה נכנסת למשטר התייעלות, והפרמטר הכלכלי הופך למכריע.</p>
                    <p><strong>התוצאה:</strong> בשל הפגיעה בציון הנגישות, מודיעין (9.00) מאבדת את המקום הראשון המשותף. פתח תקווה (9.30) הופכת למובילה הבלעדית, ומודיעין יורדת למקום השני.</p>

                    <h3>7.3 תרחיש ג': "פרימיום ומרכזיות" (Prestige)</h3>
                    <p><strong>ההנחה:</strong> העדפה למיקום יוקרתי וסביבת עבודה עשירה על פני חיסכון.</p>
                    <p><strong>התוצאה:</strong> תל אביב (8.80) והרצליה פיתוח (8.60) כובשות את הפסגה. פתח תקווה ומודיעין יורדות בדירוג, כאשר מצבה של מודיעין מחמיר בשל היעדר הרק"ל.</p>

                    <h3>7.4 תרחיש ד': "הרוב הצפוני" (North Demographics)</h3>
                    <p><strong>ההנחה:</strong> סקר העובדים מגלה כי רובם המוחלט מגיע מאזור השרון.</p>
                    <p><strong>התוצאה:</strong> הרצליה/רעננה (8.40) מצמצמת פערים והופכת לחלופה ריאלית ותחרותית לפתח תקווה.</p>

                    <h3>7.5 תרחיש ה': "הרוב הדרומי" (South Demographics)</h3>
                    <p><strong>ההנחה:</strong> סקר העובדים מגלה ריכוז גבוה של עובדים באשדוד, יבנה והשפלה.</p>
                    <p><strong>התוצאה:</strong> ראשון לציון (8.95) כובשת את המקום הראשון בפער ניכר, ודוחקת את מודיעין ופתח תקווה למקומות נמוכים יותר.</p>

                    <h3>7.6 טבלת סיכום רגישות (מטריצת החלטה)</h3>
                    <div class="report-table-wrapper">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>החלופה</th>
                                    <th>תרחיש בסיס (מאוזן)</th>
                                    <th>תרחיש א' (רכב)</th>
                                    <th>תרחיש ב' (חיסכון)</th>
                                    <th>תרחיש ג' (יוקרה)</th>
                                    <th>תרחיש ד' (צפון)</th>
                                    <th>תרחיש ה' (דרום)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="font-bold text-green-700"><td>פתח תקווה</td><td>8.75 (1)</td><td>8.55 (3)</td><td>9.30 (1)</td><td>7.90 (3)</td><td>8.85 (1)</td><td>8.25 (3)</td></tr>
                                <tr class="font-bold text-blue-700"><td>ראשון לציון</td><td>8.15 (2)</td><td>8.90 (2)</td><td>8.35 (3)</td><td>7.60 (4)</td><td>7.80 (4)</td><td>8.95 (1)</td></tr>
                                <tr><td>מודיעין</td><td>7.90 (3)</td><td>9.00 (1)</td><td>9.00 (2)</td><td>7.20 (5)</td><td>7.30 (5)</td><td>8.50 (2)</td></tr>
                                <tr><td>בני ברק</td><td>7.35 (4)</td><td>6.80 (5)</td><td>8.40 (3)</td><td>6.90 (7)</td><td>7.30 (5)</td><td>7.10 (4)</td></tr>
                                <tr><td>תל אביב</td><td>7.25 (5)</td><td>6.10 (6)</td><td>5.80 (7)</td><td>8.80 (1)</td><td>7.25 (6)</td><td>6.80 (5)</td></tr>
                                <tr><td>הבורסה</td><td>7.15 (6)</td><td>5.40 (7)</td><td>5.50 (6)</td><td>8.10 (2)</td><td>7.15 (7)</td><td>6.50 (6)</td></tr>
                                <tr><td>הרצליה/השרון</td><td>7.05 (7)</td><td>6.80 (5)</td><td>6.00 (5)</td><td>8.60 (2)</td><td>8.40 (2)</td><td>6.20 (7)</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <h3>7.7 מסקנות מניתוח הרגישות</h3>
                    <ul class="list-disc list-inside">
                        <li><strong>החלופה היציבה ("הבטוחה"):</strong> פתח תקווה. היא מדורגת במקום הראשון בשלושה מתוך שישה תרחישים, ולא יורדת מתחת למקום השלישי באף תרחיש ריאלי.</li>
                        <li><strong>החלופה האסטרטגית:</strong> ראשון לציון (מתחם האלף). אם הסקר יאשר את ההנחה שרוב העובדים הם "דרומיים" (תרחיש ה'), או אפילו בתרחיש הבסיס, מתחם האלף הופך לחלופה המועדפת השנייה.</li>
                        <li><strong>מודיעין:</strong> חלופת נישה מובהקת יותר, המתאימה בעיקר לתרחיש של התבססות על רכב פרטי וחיסכון בעלויות, אך ללא פתרון מסילתי מלא (רק"ל).</li>
                    </ul>

                    <h2>8. סיכום ומסקנות אינטגרטיביות</h2>
                    <p>תהליך הניתוח מוביל לשלוש תובנות אסטרטגיות מרכזיות:</p>
                    <ul class="list-disc list-inside">
                        <li><strong>חלופת הליבה (The Rational Choice): פתח תקווה - רמת סיב (ציון 8.75).</strong> זוהי החלופה המנצחת בתרחיש הבסיס. היא מציעה את ה-Value for Money הגבוה ביותר: שילוב של מחיר למ"ר אטרקטיבי, נגישות מעולה לרכבת הקלה וזמינות גבוהה של נכסים חדישים. החיסרון: עומסי תנועה בבקרים.</li>
                        <li><strong>החלופה האסטרטגית: ראשון לציון - מתחם האלף (ציון 8.15).</strong> זוהי כעת החלופה השנייה בטיבה. במידה ויתברר כי מרכז הכובד הדמוגרפי של העובדים נוטה דרומה, היא החלופה המנצחת. היא מציעה נגישות רכבתית ותחבורתית עדיפה עבור עובדים אלו, ועוצרת אותם "לפני הפקק".</li>
                        <li><strong>חלופות הנישה:</strong>
                            <ul class="list-none list-inside pl-4">
                                <li><strong>מודיעין (ציון 7.90):</strong> הפתרון הכלכלי ביותר והנוח ביותר לבעלי רכב ולעובדי ירושלים/שפלה, אך חסרונה הגדול הוא היעדר רכבת קלה.</li>
                                <li><strong>בני ברק (מתחם ה-BBC):</strong> חלופה כלכלית חזקה הנהנית מנגישות טובה לרכבת הקלה ומחיר אטרקטיבי, אך סובלת מצפיפות גבוהה יותר.</li>
                                <li><strong>תל אביב:</strong> רלוונטית רק בתרחיש של העדפת יוקרה על פני עלות.</li>
                                <li><strong>אזור השרון (הרצליה/רעננה):</strong> נותרת כחלופת נישה איכותית, אולם נבחר שלא להכניסה בשלב זה, בשל קושי נגישותי משמעותי עבור עובדים מדרום והיעדר פתרון מסילתי (רק"ל) בטווח הנראה לעין.</li>
                            </ul>
                        </li>
                    </ul>

                    <h2>9. המלצות להמשך פעולה</h2>
                    <p>לאור הממצאים המעודכנים, אנו ממליצים על ביצוע שני מהלכים מקבילים:</p>
                    <ul class="list-disc list-inside">
                        <li><strong>מיפוי גיאוגרפי של מגורי העובדים:</strong> ביצוע ניתוח מקיף לכתובות המגורים. תוצאת המיפוי צפויה להכריע בין פתח תקווה (אם מרבית העובדים מצפון/מזרח) לבין ראשון לציון (אם מרבית העובדים מדרום). מודיעין תישקל רק אם יתגלה ריכוז חריג של עובדים באזור ירושלים או אם החברה תבחר לוותר על רכיב הרק"ל.</li>
                        <li><strong>פניה דיסקרטית למתווכים בחלופות המועדפות:</strong> מומלץ לפרסם פנייה דיסקרטית ליזמים ולבעלי נכסים באזורים שזכו לדירוג הגבוה ביותר בניתוח:
                            <ul class="list-none list-inside pl-4">
                                <li><strong>פתח תקווה (רמת סיב / קריית אריה):</strong> החלופה הכלכלית והמאוזנת ביותר.</li>
                                <li><strong>ראשון לציון (מתחם האלף):</strong> החלופה האסטרטגית לדרום.</li>
                                <li><strong>מודיעין (פארק טכנולוגי / מע"ר):</strong> החלופה המפתיעה לבעלי רכב ולחיסכון מקסימלי (למרות היעדר רק"ל).</li>
                                <li><strong>בני ברק (מתחם ה-BBC):</strong> כחלופה כלכלית מרכזית נהנית מנגישות טובה לרכבת הקלה.</li>
                            </ul>
                        </li>
                    </ul>
                    <p>אבקש את אישורך לביצוע שני המהלכים במקביל: (1) מיפוי גיאוגרפי של מגורי עובדי המטה, ו־(2) פנייה ממוקדת לבעלי נכסים בארבע החלופות המועדפות (פתח תקווה, ראשון לציון, מודיעין, בני ברק) לצורך קבלת הצעות ראשוניות במסגרת הליך בדיקת שוק.</p>
                    
                    <div class="mt-8 pt-6 border-t border-slate-200">
                        <p class="font-bold text-slate-800">בברכה,<br>סמנכ"ל נכסים</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-slate-800 text-slate-400 py-6 mt-6 border-t border-slate-700">
        <div class="max-w-7xl mx-auto px-4 text-center text-xs">
            <p>חטיבת נכסים | דצמבר 2025</p>
        </div>
    </footer>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // Register DataLabels
        Chart.register(ChartDataLabels);

        // --- PASSWORD PROTECTION LOGIC ---
        function checkReportPassword() {
            const input = document.getElementById('report-password');
            const authDiv = document.getElementById('report-auth');
            const contentDiv = document.getElementById('report-content-body');
            const errorMsg = document.getElementById('password-error');

            if (input.value === '747474') {
                authDiv.classList.add('hidden');
                contentDiv.classList.remove('hidden');
                errorMsg.classList.add('hidden');
            } else {
                errorMsg.classList.remove('hidden');
                input.classList.add('border-red-500');
            }
        }

        // --- DATA MODEL ---
        // Immutable Default Data
        const defaultCities = {
            pt: { 
                id: 'pt', name: 'פתח תקווה', color: '#10b981', 
                lat: 32.087, lng: 34.856,
                cost: 6.5, 
                scores: { lightRail: 10, heavyRail: 7, roads: 7, bus: 9, parking: 10, cost: 10, avail: 10, quality: 9, env: 7 },
                pros: ['דירוג 1 בתרחיש בסיס (8.75)', 'חיסכון של 50% בעלויות מול ת"א', 'נגישות מלאה לקו האדום', 'קומות ענק (1,500 מ"ר+)'],
                cons: ['עומסי תנועה כבדים בבוקר', 'תדמית פחות יוקרתית', 'סביבה מנותקת בערב']
            },
            rishon: { 
                id: 'rishon', name: 'ראשון לציון', color: '#3b82f6', 
                lat: 31.985, lng: 34.765,
                cost: 7.2, 
                scores: { lightRail: 6, heavyRail: 10, roads: 9, bus: 6, parking: 10, cost: 8, avail: 9, quality: 9, env: 6 },
                pros: ['החלופה המובילה לדרום', 'צמוד לרכבת משה דיין', 'בנייה ירוקה (LEED)', 'גישה מ-431 ואיילון'],
                cons: ['אין רק"ל פעילה (2028)', 'סביבת עבודה בבינוי', 'תחבורה משלימה דלילה']
            },
            modiin: { 
                id: 'modiin', name: 'מודיעין', color: '#6366f1', 
                lat: 31.915, lng: 34.985,
                cost: 5.6, 
                // UPDATE V2: lightRail set to 0
                scores: { lightRail: 0, heavyRail: 10, roads: 10, bus: 7, parking: 10, cost: 10, avail: 9, quality: 9, env: 7 },
                pros: ['העלות הנמוכה ביותר', 'גן עדן לרכב פרטי', 'רכבת מהירה לי-ם ות"א', 'פארק עסקים מרווח'],
                cons: ['היעדר רכבת קלה (ציון 0)', 'בידוד גיאוגרפי', 'חוסר ב"חיי עיר"']
            },
            bbc: { 
                id: 'bbc', name: 'בני ברק', color: '#eab308', 
                lat: 32.095, lng: 34.830,
                cost: 7.4, 
                scores: { lightRail: 9, heavyRail: 6, roads: 6, bus: 9, parking: 6, cost: 8, avail: 8, quality: 7, env: 6 },
                pros: ['מיקום מרכזי', 'מחיר תחרותי', 'נגישות טובה לרק"ל', 'ארנונה נוחה'],
                cons: ['צפיפות גבוהה', 'עומסים במתחם', 'מצוקת חניה']
            },
            tlv: { 
                id: 'tlv', name: 'תל אביב', color: '#ef4444', 
                lat: 32.070, lng: 34.794,
                cost: 11.6, 
                scores: { lightRail: 7, heavyRail: 9, roads: 7, bus: 9, parking: 3, cost: 5, avail: 6, quality: 9, env: 10 },
                pros: ['סביבה עסקית מס\' 1', 'יוקרה ומיתוג', 'רכבת השלום', 'עירוב שימושים מלא'],
                cons: ['היקרה ביותר', 'פקקים קשים', 'מצוקת חניה']
            },
            bursa: { 
                id: 'bursa', name: 'הבורסה', color: '#f97316', 
                lat: 32.082, lng: 34.800,
                cost: 10.5, 
                scores: { lightRail: 10, heavyRail: 10, roads: 4, bus: 10, parking: 2, cost: 4, avail: 7, quality: 7, env: 9 },
                pros: ['Hub תחבורתי ראשי', 'סביבה אינטנסיבית', 'שפע שירותים'],
                cons: ['פקקים לרכב פרטי', 'מלאי ישן בחלקו', 'מחיר גבוה']
            },
            sharon: { 
                id: 'sharon', name: 'הרצליה', color: '#ec4899', 
                lat: 32.163, lng: 34.808,
                cost: 10.0, 
                scores: { lightRail: 2, heavyRail: 8, roads: 5, bus: 8, parking: 8, cost: 6, avail: 7, quality: 9, env: 10 },
                pros: ['סביבה יוקרתית', 'תדמית הייטק', 'קרבה לים'],
                cons: ['פקקים מדרום', 'אין רק"ל', 'עלויות גבוהות']
            }
        };

        // Working Copy
        let cities = JSON.parse(JSON.stringify(defaultCities));

        const scenarios = {
            base: { 
                weights: { lightRail: 15, heavyRail: 15, roads: 15, bus: 10, parking: 5, cost: 15, avail: 10, quality: 10, env: 5 },
                description: 'תרחיש מאוזן' 
            },
            south: { 
                weights: { lightRail: 10, heavyRail: 25, roads: 25, bus: 5, parking: 5, cost: 15, avail: 10, quality: 5, env: 0 },
                description: 'הרוב הדרומי' 
            },
            car: { 
                weights: { lightRail: 5, heavyRail: 10, roads: 25, bus: 5, parking: 25, cost: 10, avail: 10, quality: 5, env: 5 },
                description: 'העובד הנוהג' 
            },
            budget: { 
                weights: { lightRail: 10, heavyRail: 10, roads: 10, bus: 10, parking: 5, cost: 40, avail: 10, quality: 5, env: 0 },
                description: 'חיסכון אגרסיבי' 
            },
            prestige: { 
                weights: { lightRail: 15, heavyRail: 10, roads: 10, bus: 10, parking: 5, cost: 5, avail: 5, quality: 20, env: 20 },
                description: 'יוקרה' 
            },
            north: {
                weights: { lightRail: 5, heavyRail: 25, roads: 5, bus: 10, parking: 10, cost: 5, avail: 10, quality: 15, env: 15 },
                description: 'הרוב הצפוני'
            }
        };

        const paramsLabels = {
            lightRail: { label: 'רק"ל', icon: 'fa-train-subway' },
            heavyRail: { label: 'רכבת', icon: 'fa-train' },
            roads: { label: 'רכב', icon: 'fa-car' },
            bus: { label: 'אוטובוס', icon: 'fa-bus' },
            parking: { label: 'חניה', icon: 'fa-square-parking' },
            cost: { label: 'עלות', icon: 'fa-shekel-sign' },
            quality: { label: 'איכות', icon: 'fa-building' },
            env: { label: 'סביבה', icon: 'fa-tree' }
        };

        let mainChartInstance = null;
        let costChartInstance = null;
        let customChartInstance = null;
        let currentScenarioKey = 'base';
        let isEditMode = false;
        let mapInstance = null;

        // --- CALCULATION LOGIC ---

        function calculateRanking(weights) {
            const results = [];
            let sumWeights = 0;
            for (const p in weights) sumWeights += weights[p];
            if (sumWeights === 0) sumWeights = 1; 

            for (const key in cities) {
                const city = cities[key];
                let score = 0;
                for (const param in weights) {
                    if(city.scores[param] !== undefined) {
                        score += city.scores[param] * weights[param];
                    }
                }
                const finalScore = (score / sumWeights); 
                results.push({
                    key: key,
                    name: city.name,
                    score: finalScore.toFixed(2),
                    color: city.color,
                    rawScores: city.scores
                });
            }
            return results.sort((a, b) => b.score - a.score);
        }

        // --- DASHBOARD UI ---

        function setScenario(key) {
            currentScenarioKey = key;
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-50', 'border-secondary', 'shadow-md');
                btn.classList.add('border-slate-200');
            });
            const activeBtn = document.getElementById(`btn-${key}`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-blue-50', 'border-secondary', 'shadow-md');
                activeBtn.classList.remove('border-slate-200');
            }

            const rankingData = calculateRanking(scenarios[key].weights);
            updateMainChart(rankingData);
            populateDrillDownTable(rankingData);
        }

        function populateDrillDownTable(data) {
            const tbody = document.getElementById('drilldown-body');
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const s = item.rawScores;
                const cell = (val, param) => {
                    if (isEditMode) {
                        return `<input type="number" min="0" max="10" value="${val}" 
                                class="score-input"
                                onchange="updateScore('${item.key}', '${param}', this.value)">`;
                    }
                    return val;
                };

                const row = `
                    <tr class="hover:bg-white transition">
                        <td class="p-2 font-bold text-slate-700 border-b">${item.name}</td>
                        <td class="p-2 text-center border-b">${cell(s.lightRail, 'lightRail')}</td>
                        <td class="p-2 text-center border-b">${cell(s.heavyRail, 'heavyRail')}</td>
                        <td class="p-2 text-center border-b">${cell(s.roads, 'roads')}</td>
                        <td class="p-2 text-center border-b">${cell(s.bus, 'bus')}</td>
                        <td class="p-2 text-center border-b">${cell(s.parking, 'parking')}</td>
                        <td class="p-2 text-center border-b text-green-600 font-bold">${cell(s.cost, 'cost')}</td>
                        <td class="p-2 text-center border-b">${cell(s.quality, 'quality')}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('btn-edit-scores');
            const hint = document.getElementById('edit-hint');
            
            if (isEditMode) {
                btn.innerHTML = '<i class="fa-solid fa-check"></i> סיום עריכה';
                btn.classList.replace('bg-blue-50', 'bg-green-50');
                btn.classList.replace('text-blue-600', 'text-green-600');
                btn.classList.replace('border-blue-100', 'border-green-100');
                hint.classList.add('hidden');
            } else {
                btn.innerHTML = '<i class="fa-solid fa-pen"></i> ערוך ציונים';
                btn.classList.replace('bg-green-50', 'bg-blue-50');
                btn.classList.replace('text-green-600', 'text-blue-600');
                btn.classList.replace('border-green-100', 'border-blue-100');
                hint.classList.remove('hidden');
            }
            
            // Re-render table with/without inputs
            const rankingData = calculateRanking(scenarios[currentScenarioKey].weights);
            populateDrillDownTable(rankingData);
        }

        function updateScore(cityKey, param, value) {
            let val = parseFloat(value);
            if (isNaN(val)) val = 0;
            if (val > 10) val = 10;
            if (val < 0) val = 0;
            
            // Update Data Model
            cities[cityKey].scores[param] = val;
            
            // Refresh everything
            setScenario(currentScenarioKey);
        }

        function resetScores() {
            if (confirm('האם לאפס את כל הציונים לברירת המחדל?')) {
                cities = JSON.parse(JSON.stringify(defaultCities));
                setScenario(currentScenarioKey);
                if (isEditMode) toggleEditMode(); // Exit edit mode
            }
        }

        function toggleDrillDown() {
            const container = document.getElementById('drilldown-container');
            container.classList.toggle('hidden');
        }

        function toggleCostTable() {
            const container = document.getElementById('cost-table-container');
            container.classList.toggle('hidden');
        }

        function updateMainChart(data) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (mainChartInstance) mainChartInstance.destroy();

            mainChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        label: 'ציון',
                        data: data.map(d => d.score),
                        backgroundColor: data.map(d => d.color),
                        borderRadius: 4,
                        barThickness: 'flex',
                        maxBarThickness: 35
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        datalabels: {
                            color: '#1e293b',
                            anchor: 'end',
                            align: 'top',
                            font: { weight: 'bold', size: 11 },
                            formatter: (value) => value
                        }
                    },
                    scales: {
                        y: { beginAtZero: false, min: 0, max: 11, display: false },
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } }
                    },
                    layout: { padding: { top: 20 } }
                }
            });
        }

        // --- CUSTOM UI ---

        function initCustomView() {
            const container = document.getElementById('sliders-container');
            container.innerHTML = '';
            const baseWeights = scenarios.base.weights; // Copy initial weights

            if (!window.currentCustomWeights) {
                window.currentCustomWeights = {...baseWeights};
            }

            // Define display params (subset of all params)
            const displayParams = {
                lightRail: { label: 'רק"ל', icon: 'fa-train-subway' },
                heavyRail: { label: 'רכבת', icon: 'fa-train' },
                roads: { label: 'רכב', icon: 'fa-car' },
                bus: { label: 'אוטובוס', icon: 'fa-bus' },
                parking: { label: 'חניה', icon: 'fa-square-parking' },
                cost: { label: 'עלות', icon: 'fa-shekel-sign' },
                quality: { label: 'איכות', icon: 'fa-building' },
                env: { label: 'סביבה', icon: 'fa-tree' }
            };

            for (const [key, config] of Object.entries(displayParams)) {
                const initialVal = window.currentCustomWeights[key] || 0;
                const html = `
                    <div class="flex items-center gap-2 text-sm">
                        <div class="w-24 flex-shrink-0 flex items-center text-slate-700 font-medium">
                            <i class="fa-solid ${config.icon} w-5 text-primary"></i> ${config.label}
                        </div>
                        <input type="range" min="0" max="100" step="0.1" value="${initialVal}" 
                               id="slider-${key}"
                               class="flex-grow"
                               oninput="onSliderChange('${key}', this.value)">
                        <span class="w-12 text-center font-mono font-bold text-primary text-xs bg-slate-100 rounded" id="val-${key}">${initialVal}%</span>
                    </div>
                `;
                container.innerHTML += html;
            }
            updateCustomAnalysis();
        }

        function onSliderChange(changedKey, newValue) {
            newValue = parseFloat(newValue);
            const targetTotal = 100.0;
            
            // 1. Update the changed weight in our state
            window.currentCustomWeights[changedKey] = newValue;
            
            // 2. Calculate remaining budget
            const remainingBudget = Math.max(0, targetTotal - newValue);
            
            // 3. Identify other keys (only the ones we display/control)
            const displayParamsKeys = ['lightRail', 'heavyRail', 'roads', 'bus', 'parking', 'cost', 'quality', 'env'];
            const otherKeys = displayParamsKeys.filter(k => k !== changedKey);
            
            // 4. Sum of others current values
            let sumOthers = 0;
            otherKeys.forEach(k => sumOthers += (window.currentCustomWeights[k] || 0));
            
            // 5. Redistribute remaining budget proportionally
            if (sumOthers > 0) {
                otherKeys.forEach(k => {
                    const ratio = window.currentCustomWeights[k] / sumOthers;
                    window.currentCustomWeights[k] = remainingBudget * ratio;
                });
            } else if (remainingBudget > 0 && otherKeys.length > 0) {
                 const equalShare = remainingBudget / otherKeys.length;
                 otherKeys.forEach(k => window.currentCustomWeights[k] = equalShare);
            } else {
                 otherKeys.forEach(k => window.currentCustomWeights[k] = 0);
            }

            // 6. Rounding Fix
            let currentSum = 0;
            displayParamsKeys.forEach(k => {
                window.currentCustomWeights[k] = Math.round(window.currentCustomWeights[k] * 10) / 10;
                currentSum += window.currentCustomWeights[k];
            });

            const error = targetTotal - currentSum;
            if (Math.abs(error) > 0.001) {
                let adjustKey = otherKeys[0];
                let maxVal = -1;
                otherKeys.forEach(k => {
                    if (window.currentCustomWeights[k] > maxVal) {
                        maxVal = window.currentCustomWeights[k];
                        adjustKey = k;
                    }
                });
                window.currentCustomWeights[adjustKey] += error;
                window.currentCustomWeights[adjustKey] = Math.round(window.currentCustomWeights[adjustKey] * 10) / 10;
            }

            // 7. Update UI elements
            displayParamsKeys.forEach(k => {
                const val = window.currentCustomWeights[k];
                const textEl = document.getElementById(`val-${k}`);
                if(textEl) textEl.innerText = val.toFixed(1) + '%';
                
                if (k !== changedKey) {
                    const sliderEl = document.getElementById(`slider-${k}`);
                    if(sliderEl) sliderEl.value = val;
                }
            });

            updateCustomAnalysis();
        }

        function resetCustomSliders() {
            window.currentCustomWeights = null; // Clear state
            initCustomView();
        }

        function updateCustomAnalysis() {
            // Use the global state weights for calculation
            const data = calculateRanking(window.currentCustomWeights);
            
            // Update Total Label
            let total = 0;
             const displayParamsKeys = ['lightRail', 'heavyRail', 'roads', 'bus', 'parking', 'cost', 'quality', 'env'];
             displayParamsKeys.forEach(k => total += (window.currentCustomWeights[k] || 0));
            const totalEl = document.getElementById('total-weight');
            if(totalEl) totalEl.innerText = Math.round(total) + '%';

            const ctx = document.getElementById('customChart').getContext('2d');
            if (customChartInstance) customChartInstance.destroy();

            customChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        data: data.map(d => d.score),
                        backgroundColor: data.map(d => d.color),
                        borderRadius: 4,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        datalabels: {
                            color: '#1e293b',
                            anchor: 'end',
                            align: 'end',
                            font: { weight: 'bold', size: 11 }
                        }
                    },
                    scales: {
                        x: { beginAtZero: true, max: 11, display: false },
                        y: { grid: { display: false }, ticks: { font: { size: 11 } } }
                    },
                    layout: { padding: { right: 30 } },
                    animation: { duration: 0 }
                }
            });
        }

        // --- MAP LOGIC ---
        function initMap() {
            if (mapInstance) return;

            mapInstance = L.map('map').setView([32.05, 34.85], 11);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);

            // Add markers
            for (const key in cities) {
                const city = cities[key];
                
                // Get current score in base scenario
                const rankingData = calculateRanking(scenarios.base.weights);
                const cityData = rankingData.find(c => c.key === key);
                const score = cityData ? cityData.score : 0;

                const markerHtml = `
                    <div style="background-color: ${city.color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                `;
                
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: markerHtml,
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });

                const popupContent = `
                    <div style="text-align: right; direction: rtl;">
                        <h3 style="margin: 0 0 5px; color: ${city.color}; font-weight: bold;">${city.name}</h3>
                        <div style="font-size: 14px; margin-bottom: 5px;"><strong>ציון (בסיס): ${score}</strong></div>
                        <div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">עלות: ${city.cost} מלש"ח</div>
                        <button onclick="renderCityDetail('${key}'); switchView('details');" style="background: #004aad; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">פרטים מלאים</button>
                    </div>
                `;

                L.marker([city.lat, city.lng], { icon: icon })
                    .addTo(mapInstance)
                    .bindPopup(popupContent);
            }
        }

        // --- SHARED ---

        function initCostChart() {
            const ctx = document.getElementById('costChart').getContext('2d');
            const sortedCities = Object.values(cities).sort((a, b) => b.cost - a.cost);
            if (costChartInstance) costChartInstance.destroy();
            costChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedCities.map(c => c.name),
                    datasets: [{
                        data: sortedCities.map(c => c.cost),
                        backgroundColor: sortedCities.map(c => c.color),
                        borderRadius: 4,
                        barThickness: 15
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        datalabels: {
                            color: '#1e293b',
                            anchor: 'end',
                            align: 'end',
                            formatter: (val) => val + ' M',
                            font: { size: 10, weight: 'bold' }
                        }
                    },
                    scales: { x: { display: false, max: 14 }, y: { grid: { display: false }, ticks: { font: { size: 10 } } } },
                    layout: { padding: { right: 30 } }
                }
            });
        }

        function switchView(viewName) {
            ['dashboard', 'custom', 'details', 'report', 'map'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                document.getElementById(`nav-${v}`).classList.remove('active', 'text-primary');
            });
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            document.getElementById(`nav-${viewName}`).classList.add('active', 'text-primary');
            if (viewName === 'custom') initCustomView();
            if (viewName === 'map') {
                setTimeout(() => {
                    initMap();
                    if(mapInstance) mapInstance.invalidateSize();
                }, 100);
            }
        }

        function renderCityDetail(cityId) {
            const city = cities[cityId];
            const contentDiv = document.getElementById('city-content');
            
            const scoreBar = (label, val) => `
                <div class="mb-2">
                    <div class="flex justify-between text-xs mb-1">
                        <span class="font-semibold text-slate-600">${label}</span>
                        <span class="font-bold text-slate-800">${val}/10</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-1.5">
                        <div class="bg-primary h-1.5 rounded-full" style="width: ${val * 10}%"></div>
                    </div>
                </div>
            `;

            contentDiv.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex justify-between items-start mb-4 border-b pb-2">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800" style="color: ${city.color}">${city.name}</h2>
                            <span class="text-xs text-slate-500">עלות: ${city.cost} מלש"ח</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="bg-green-50 p-3 rounded-lg border border-green-100">
                                <h4 class="font-bold text-green-700 text-sm mb-2"><i class="fa-solid fa-thumbs-up ml-1"></i> יתרונות</h4>
                                <ul class="list-disc list-inside space-y-1 text-xs text-slate-700">
                                    ${city.pros.map(p => `<li>${p}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                                <h4 class="font-bold text-red-700 text-sm mb-2"><i class="fa-solid fa-triangle-exclamation ml-1"></i> חסרונות</h4>
                                <ul class="list-disc list-inside space-y-1 text-xs text-slate-700">
                                    ${city.cons.map(c => `<li>${c}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 text-sm mb-3">פרופיל ציונים</h4>
                            <div class="grid grid-cols-1 gap-1">
                                ${scoreBar('רק"ל', city.scores.lightRail)}
                                ${scoreBar('רכבת', city.scores.heavyRail)}
                                ${scoreBar('רכב', city.scores.roads)}
                                ${scoreBar('חניה', city.scores.parking)}
                                ${scoreBar('עלות', city.scores.cost)}
                                ${scoreBar('איכות', city.scores.quality)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.addEventListener('DOMContentLoaded', () => {
            Chart.defaults.font.family = 'Heebo';
            setScenario('base');
            initCostChart();
            renderCityDetail('pt');
        });

    </script>
</body>
</html>
